# Документация балансировщика нагрузки

## Общее описание
Проект реализует балансировщик нагрузки по алгоритму Round Robin с проверкой здоровья серверов и ограничением запросов (rate limiting). Система распределяет HTTP-запросы между несколькими серверами и защищает от перегрузки со стороны отдельных клиентов.

## Основные компоненты

### 1. Балансировщик Round Robin (`round-robin.go`)

- **Функционал**:
  - Равномерное распределение запросов между серверами
  - Автоматическая проверка здоровья серверов (каждые 5 секунд)
  - Интеграция с модулем rate limiting
  - Проксирование запросов на выбранные серверы

- **Ключевые методы**:
  - `GetNextServer()` - выбор следующего доступного сервера
  - `HandleRequest()` - обработка входящего запроса
  - `StartHealthCheck()` - фоновый мониторинг состояния серверов

### 2. Серверная часть (`server.go`, `handlers.go`)

- **Сервер (`server.go`)**:
  - Поддержка состояния (здоров/не здоров)
  - Обработка задач с заданной задержкой
  - Логирование операций

- **Обработчики (`handlers.go`)**:
  - `/process` - обработка задач с параметром времени выполнения
  - `/health` - проверка состояния сервера
  - Валидация входных параметров

### 3. Ограничение запросов (`rateLimiter.go`, `bucket.go`, `client.go`)

- **Иерархия**:
  - `RateLimiter` - управляет клиентами
  - `Client` - хранит состояние клиента (IP + bucket)
  - `Bucket` - реализует алгоритм token bucket

- **Особенности**:
  - Настройки по умолчанию: 10 запросов/сек
  - Возврат токенов при ошибках
  - Очистка неактивных клиентов
  - Поддержка конфигурации из JSON-файла

### 4. Логирование (`logger.go`)

- Автоматическое создание директории logs и файлов логов в случае их отсутствия
- Запись логов в файлы формата `logs/[name]_[port].log`
- Формат логов:`[дата] [время] [микросекунды] Сообщение`

## Принцип работы

1. Клиент отправляет запрос на балансировщик
2. Rate Limiter проверяет лимиты для IP клиента
3. Балансировщик выбирает здоровый сервер
4. Запрос проксируется на выбранный сервер
5. Сервер выполняет задачу и логгирует результат
6. Состояние серверов постоянно проверяется

## Обработка ошибок

- `ErrNoHealthyServers` - нет доступных серверов
- `ErrInvalidResponse` - некорректный ответ сервера
- `ErrNotANumber`/`ErrNegativeNumber`/`ErrTooBigNumber` - ошибки валидации времени выполнения

## Настройки

Основные параметры:
- Интервал проверки здоровья: 5 сек
- Таймаут неактивности клиентов: 5 мин
- Интервал очистки клиентов: 5 мин
- Лимиты запросов настраиваются через `config/rate_limits.json`


