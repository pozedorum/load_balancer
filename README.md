# Cloud Ru Task

# Балансировщик нагрузки + ограничитель запросов
## Описание проекта

Этот проект представляет собой простой балансировщик нагрузки, который принимает входящие HTTP-запросы и распределяет их по пулу бэкенд-серверов. Проект реализован на языке Go и включает в себя следующие функции:

* Балансировщик нагрузки с поддержкой round-robin алгоритма
* Реализация rate-limiting на основе алгоритма Token Bucket
* Поддержка конфигурации через внешний конфигурационный файл и параметры командной строки
* Логирование входящих запросов, ошибок и событий

В качестве полезной нагрузки я использовал функцию ProcessTask лежащую в server.go, она получает на вход время выполнения и ждёт пока это время пройдёт. Соответственно во всех запросах я подаю время в качестве параметра (оно исчисляется в миллисекундах) `-H "Execution-Time: $exec_time"`
Обратно пользователь получает только ответ в виде кодов 202 (принято на обработку), 429 (Слишком много запросов) и 500-е коды в случае неработаоспособности сервера.
Результат обработки запросов сохраняется в логах.

## Сборка и запуск проекта

Как таковой сборки нет, так как есть несколько серверов + сервер-балансировщик вся сборка и все тесты работают через bash-скрипты

Перед запуском убедитесь, что у вас стоит утилита jq
Вот команды для её установки
На Ubuntu
```
sudo apt-get install jq
```
На macOS
```
brew install jq
```
### Запуск проекта

0. Перейти в папку src, все команды написаны относительно этой директории
1. Выполнить команду `sh scripts/run_all.sh ` для запуска проекта и дождаться строки `Starting load balancer (logs: logs/balancer_8080.log)`
2. В другом терминале запускать све остальные скрипты
3. Чтобы завершить работу серверов достаточно нажать комбинацию `Ctrl + C` в первом терминале, после этого скрипт завершит свою работу (не аварийно, баш скрипт ловит `SIGINT` и другие сигналы и правильно завершает работу)


## Тестирование проекта

Для тестирования я подготовил несколько bash-скриптов:

1. simple_test.sh — простейший тест, проверяющий соединение с серверами через эндпоинт `/health`. Для запуска используйте команду `sh scripts/simple_test.sh` 

2. random_tasks.sh — ещё один простой тест, запускает 5 запросов со случайным временем в диапазоне от 1 до 5 секунд. Для запуска используйте команду `sh scripts/random_tasks.sh`

3. check_servers.sh - уже более комплексный тест, отправляет много запросов с одного IP, проверяет граничные случаи запросов (отрицательное или слишком большое время, строка вместо числа). В логах можно посмотреть результат обработки запросов. Для запуска используйте команду `sh scripts/check_servers.sh`

4. check_servers2.sh - тест направленный на проверку работы ограничителя запросов, отправляет много запросов с разных серверов и выводит ответ от балансировщика (принято в обработку, отклонено, ошибка с подключением к серверу), в конце статистика по ответам на запросы. Для запуска используйте команду `sh scripts/check_servers2.sh`


### Конфигурационный файл

* Файлы конфигурации находятся в папке `config`

* Файл `rate_limits.json` отвечает за настройку клиентов и установку дефолтных настроек бакетов.
* Файл `servers.json` отвечает за количество и порты бэкэнд-серверов, можно изменять их количество.

### Параметры командной строки

* Параметры командной строки есть у бэкэнд-серверов. При запуске скрипта утилита jq парсит servers.json и использует id и port в качестве параметров командной строки


### Интеграционные тесты

* Увы мне не хватило времени на интеграционные тесты и базу данных, поэтому их нет.

## Документация

* Документация проекта находится в папке `docs`
* Документация включает в себя описание функций и классов проекта

## Авторы

* Приходько Аркадий(ник Pozedorum)
https://github.com/pozedorum

## Личное мнение

Мне очень понравилось работать над этим проектом, в процессе разработки я лучше разобрался в параллельности, контекстах и организации системы. Это был ценный опыт, который показал где мне не хватает знаний и как их восполнять.

